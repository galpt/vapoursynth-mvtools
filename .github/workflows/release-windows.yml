name: Release-Windows

on:
  push:
    branches:
    - main
    - master
    tags:
    - 'v*'
  workflow_dispatch:


permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: [ self-hosted ]
    defaults:
      run:
        shell: pwsh
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Verify NVIDIA GPU and CUDA Toolkit
      shell: pwsh
      run: |
        Write-Host "=== Checking NVIDIA GPU and CUDA Toolkit ==="

        # Check nvidia-smi (driver)
        $nvsmi = Get-Command nvidia-smi -ErrorAction SilentlyContinue
        if ($nvsmi) {
          Write-Host "[OK] nvidia-smi found: $($nvsmi.Path)"
          nvidia-smi --query-gpu=name,driver_version,cuda_version --format=csv
        } else {
          Write-Host "[WARN] nvidia-smi not found in PATH. NVIDIA drivers may not be installed."
        }

        # Check CUDA Toolkit (nvcc compiler)
        $nvcc = Get-Command nvcc -ErrorAction SilentlyContinue
        if ($nvcc) {
          Write-Host "[OK] CUDA Toolkit found: $($nvcc.Path)"
          nvcc --version
        } else {
          Write-Host "[WARN] nvcc not found. CUDA Toolkit may not be installed or not in PATH."
        }

        # Check for cuda_runtime.h header
        $cudaPaths = @(
          "$env:CUDA_PATH\include\cuda_runtime.h",
          "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.0\include\cuda_runtime.h",
          "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8\include\cuda_runtime.h"
        )
        $cudaHeaderFound = $false
        foreach ($p in $cudaPaths) {
          if (Test-Path $p) {
            Write-Host "[OK] CUDA headers found: $p"
            $cudaHeaderFound = $true
            break
          }
        }
        if (-not $cudaHeaderFound) {
          Write-Host "[ERROR] cuda_runtime.h not found. Please install CUDA Toolkit from https://developer.nvidia.com/cuda-downloads"
          Write-Host "Your RTX 3050 supports CUDA, but the toolkit must be installed separately from drivers."
          exit 1
        }

        Write-Host "=== GPU/CUDA Check Complete ==="

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          base-devel mingw-w64-x86_64-jq mingw-w64-x86_64-gcc mingw-w64-x86_64-pkg-config mingw-w64-x86_64-vapoursynth mingw-w64-x86_64-meson mingw-w64-x86_64-ninja mingw-w64-x86_64-nasm mingw-w64-x86_64-fftw

    - name: Verify runner CUDA availability
      id: cuda-check
      run: |
        $nvcc = (Get-Command nvcc -ErrorAction SilentlyContinue)
        if ($nvcc) { Write-Host "nvcc present: $($nvcc.Path)"; exit 0 }
        Write-Host "nvcc not found on runner; attempting to continue â€” CUDA toolkit must be present for NvOF builds."; exit 0

    - name: Assemble NvOF SDK from repository parts
      shell: pwsh
      run: |
        $workspace = $env:GITHUB_WORKSPACE
        $parts = Get-ChildItem -Path (Join-Path $workspace 'Optical_Flow_SDK_*.zip.*') -File | Sort-Object Name
        if ($parts.Count -eq 0) {
          Write-Host "No split SDK parts found in repository. Ensure Optical_Flow_SDK_*.zip.001/002/003 are present."; exit 1
        }
        $outZip = Join-Path $env:TEMP 'nv_of_sdk.zip'
        if (Test-Path $outZip) { Remove-Item $outZip -Force }
        $outStream = [System.IO.File]::OpenWrite($outZip)
        foreach ($p in $parts) {
          Write-Host "Appending $($p.FullName)"
          $in = [System.IO.File]::OpenRead($p.FullName)
          $in.CopyTo($outStream)
          $in.Close()
        }
        $outStream.Close()
        # Validate ZIP magic bytes
        $bytes = [System.IO.File]::ReadAllBytes($outZip)[0..3]
        if ($bytes[0] -ne 0x50 -or $bytes[1] -ne 0x4B) { Write-Error "Assembled file is not a ZIP archive"; exit 1 }
        $outDir = Join-Path $env:TEMP 'nv_of_sdk'
        if (Test-Path $outDir) { Remove-Item $outDir -Recurse -Force }
        Expand-Archive -Path $outZip -DestinationPath $outDir -Force
        Write-Host "NvOF SDK assembled and extracted to $outDir"
        echo "NV_OF_SDK=$outDir" >> $env:GITHUB_ENV

    - name: Configure & build
      shell: msys2 {0}
      run: |
        # Candidate SDK locations (extracted tmp, env var, common install path)
        candidates=(
          "${TEMP}/nv_of_sdk"
          "${NV_OF_SDK}"
          "/c/Program Files/NVIDIA Corporation/OpticalFlow-SDK"
          "/c/Program Files/NVIDIA Corporation/NvOpticalFlow"
        )

        sdkPath=""
        for candidate in "${candidates[@]}"; do
          if [[ -d "$candidate" ]]; then
            sdkPath="$candidate"
            break
          fi
        done

        if [[ -z "$sdkPath" ]]; then
          echo "NvOF SDK not found. Provide secret NV_OF_SDK_URL, set NV_OF_SDK on the runner, or use a self-hosted runner with the SDK installed."
          exit 1
        fi

        echo "Using NvOF SDK at: $sdkPath"

        # Auto-detect CUDA Toolkit installation
        cuda_candidates=(
          "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v13.1"
          "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v13.0"
          "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.6"
          "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.5"
          "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.0"
          "/c/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v11.8"
        )

        cudaPath=""
        for cuda_candidate in "${cuda_candidates[@]}"; do
          if [[ -d "$cuda_candidate" ]]; then
            cudaPath="$cuda_candidate"
            echo "Found CUDA Toolkit at: $cudaPath"
            break
          fi
        done

        if [[ -z "$cudaPath" ]]; then
          echo "ERROR: CUDA Toolkit not found! Install CUDA from https://developer.nvidia.com/cuda-downloads"
          exit 1
        fi

        # Configure Meson with both NvOF SDK and CUDA paths
        meson setup build \
          --buildtype release \
          --prefer-static \
          --default-library=static \
          -Dcpp_link_args='-static' \
          -Dnv_of_sdk="$sdkPath" \
          -Dcuda_path="$cudaPath"

        meson compile -vC build

    - name: Export version
      shell: msys2 {0}
      run: |
        echo "ARTIFACT_VERSION=$(meson introspect --projectinfo build | jq -r '.version')" >> $GITHUB_ENV

    - name: Prepare release artifact
      shell: pwsh
      run: |
        $out = "mvtools-windows-x64-$env:ARTIFACT_VERSION"
        New-Item -ItemType Directory -Path release -Force
        Copy-Item build/libmvtools.dll -Destination (Join-Path -Path release -ChildPath "$out.dll") -Force
        Compress-Archive -Path release\* -DestinationPath "$out.zip" -Force
        Write-Host "Created $out.zip"

    - name: Generate release tag
      id: tag
      shell: pwsh
      run: |
        $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
        $tag = "release-$timestamp"
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: mvtools ${{ steps.tag.outputs.timestamp }}
        body: |
          NvOF-enabled build (requires CUDA + NvOF SDK)

          Commit: ${{ github.sha }}
        files: |
          mvtools-windows-x64-${{ env.ARTIFACT_VERSION }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
